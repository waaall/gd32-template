# PMU (Phasor Measurement Unit) 项目

基于GD32F4xx + FreeRTOS + CMSIS-DSP的电网同步相量测量装置。

## 项目结构

### 核心模块

1. **ADC驱动模块** (`adc_driver.h/c`)
   - 负责ADC数据采集
   - DMA双缓冲管理
   - 定时器触发配置
   - 原始数据转换为物理量

2. **FFT相量计算模块** (`fft_phasor_task.h/c`)
   - Hann窗函数处理
   - FFT变换
   - 频率估算（插值DFT + 相位差融合）
   - 相量参数计算（频率、幅度、相位、ROCOF）

3. **通信驱动模块** (`com_driver.h/c`)
   - UART通信接口
   - IEEE C37.118协议支持
   - 自定义数据协议
   - 数据发送和状态监控

4. **主程序** (`pmu_main.c`)
   - 系统初始化
   - 任务协调
   - 系统监控和状态管理

## 技术特性

- **采样频率**: 10 kHz
- **通道数**: 6个（3个电压通道 + 3个电流通道）
- **帧长度**: 200个样本点（20ms数据帧）
- **FFT长度**: 256点（零填充）
- **频率精度**: 抛物线插值DFT + 相位差融合算法
- **通信协议**: IEEE C37.118-2011标准 + 自定义协议

## 主要算法

### 1. 相量测量算法
```
1. Hann窗函数加权
2. 零填充至256点
3. 快速傅里叶变换（RFFT）
4. 基于历史频率的bin估算
5. 三点抛物线插值求精确频率
6. 相位差法频率跟踪
7. 加权融合最终频率估算
8. 幅度校正和ROCOF计算
```

### 2. 数据流程
```
ADC采样 -> DMA双缓冲 -> 队列通知 -> 相量计算 -> 通信发送
         -> 原始数据转换 -> FFT处理 -> 参数估算 -> 结果输出
```

## 配置参数

### ADC配置
- 采样率: 10 kHz
- 分辨率: 12位
- 触发源: TIMER1 TRGO
- DMA模式: 循环双缓冲

### 相量算法配置
- 标称频率: 50 Hz
- 频率跟踪系数: 0.6
- 窗函数能量校正: 2.0
- 异常值检测阈值: 5 Hz

### 通信配置
- 波特率: 115200
- 数据发送周期: 20ms (50Hz数据率)
- 协议: IEEE C37.118或自定义格式

## 使用方法

### 1. 硬件连接
- PA0-PA5: ADC模拟输入（电压/电流信号）
- PA9: UART TX (通信输出)
- PA10: UART RX (命令接收)
- PC13: 状态LED

### 2. 软件编译
```bash
make clean
make
```

### 3. 程序烧录
```bash
make download
```

### 4. 系统启动
1. 系统上电后自动初始化各模块
2. 启动ADC采样和相量计算
3. 通过UART输出测量结果
4. LED心跳指示系统运行状态

## 输出数据格式

### IEEE C37.118格式
```
[同步字][帧长度][PMU_ID][时间戳][相量数据][频率][ROCOF][校验和]
```

### 自定义格式（CSV）
```
PMU,帧索引,时间戳,频率1,幅度1,相位1,频率2,幅度2,相位2,...
```

## 系统监控

系统提供以下监控功能：
- 处理帧数统计
- 平均/最大处理时间
- 通信包统计
- 内存使用监控
- 任务栈使用监控

## 错误处理

- 栈溢出检测
- 内存分配失败处理
- ADC采样状态监控
- 通信链路监控
- 异常值检测和过滤

## 扩展功能

### 可添加的功能
1. GPS时间同步
2. 以太网通信接口
3. SD卡数据记录
4. Web配置界面
5. 更多信号处理算法

### 性能优化
1. 使用硬件浮点单元(FPU)
2. DMA数据处理优化
3. 中断优先级调整
4. 任务调度优化

## 注意事项

1. **硬件前端**: 需要合适的电压/电流变换器和抗混叠滤波器
2. **时钟精度**: 系统时钟精度直接影响频率测量精度
3. **电源质量**: 使用高质量电源以减少噪声干扰
4. **散热设计**: 确保MCU在合适温度范围内工作

## 开发和调试

### 调试输出
通过UART0输出调试信息，包括：
- 系统初始化信息
- 统计数据
- 错误信息
- 心跳状态

### 性能测试
- 使用示波器监测ADC采样精度
- 用标准信号源测试频率测量精度
- 监控任务执行时间和CPU使用率

## 联系信息

项目开发者: zhengxu
版本: V1.0.0
日期: 2025-08-29
